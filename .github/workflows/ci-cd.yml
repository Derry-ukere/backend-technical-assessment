name: CI/CD Pipeline

on:
  push:
    branches: [main, staging, develop, 'feat/**']
  pull_request:
    branches: [main, staging, develop]

env:
  NODE_VERSION: '20'
  DOCKER_HUB_USERNAME: derryukere
  IMAGE_NAME: school-management-api

jobs:
  # Lint and Test
  test:
    name: Test
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit
        env:
          NODE_ENV: test
          MONGO_URI: mongodb://localhost:27017/school_management_test
          REDIS_URI: redis://localhost:6379
          CORTEX_REDIS: redis://localhost:6379
          CORTEX_PREFIX: test_cortex
          CORTEX_TYPE: school-management-api
          OYSTER_REDIS: redis://localhost:6379
          OYSTER_PREFIX: test_oyster
          CACHE_REDIS: redis://localhost:6379
          CACHE_PREFIX: test_cache
          LONG_TOKEN_SECRET: test-long-token-secret
          SHORT_TOKEN_SECRET: test-short-token-secret
          NACL_SECRET: test-nacl-secret
          USER_PORT: 3000

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        continue-on-error: true

  # Build and Push Docker Image - Development (develop branch)
  build-dev:
    name: Build & Push (Dev)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:dev
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:dev-${{ steps.sha.outputs.short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build and Push Docker Image - Staging (staging branch)
  build-staging:
    name: Build & Push (Staging)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:staging
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:staging-${{ steps.sha.outputs.short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build and Push Docker Image - Production (main branch)
  build-prod:
    name: Build & Push (Prod)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:prod
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:prod-${{ steps.sha.outputs.short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
